# 项目结构说明

## 整体架构

```
牙齿分割深度学习项目
├── 配置层
│   ├── config.py              # 全局配置
│   └── requirements.txt       # 依赖管理
├── 数据层
│   ├── utils/dataset.py       # 数据加载和预处理
│   └── data/ToothSegmDataset/ # 数据集
├── 模型层
│   ├── models/unet.py         # U-Net + FiLM条件化
│   └── models/loss.py         # 损失函数
├── 工具层
│   ├── utils/metrics.py       # 评估指标
│   └── utils/visualization.py # 可视化工具
├── 应用层
│   ├── train.py               # 训练脚本
│   ├── test.py                # 测试脚本
│   └── run_example.py         # 示例运行
└── 输出层
    └── outputs/               # 所有输出结果
```

## 核心组件

### 1. 模型架构 (models/unet.py)
```
ConditionalUNet
├── 编码器 (4层下采样)
│   ├── DoubleConv
│   ├── Down (MaxPool + DoubleConv)
│   └── FiLM条件化
├── 瓶颈层
│   ├── DoubleConv
│   └── FiLM条件化
├── 解码器 (4层上采样)
│   ├── Up (Upsample + DoubleConv)
│   └── 跳跃连接
└── 输出层
    └── OutConv (1x1卷积)
```

### 2. 条件化机制
```
牙齿ID → 嵌入层 → FiLM调制
                ↓
        特征图 × scale + shift
```

### 3. 数据流程
```
原始图像 + 牙齿ID
    ↓
数据预处理 (归一化、增强)
    ↓
模型前向传播
    ↓
损失计算 (BCE + Dice + Focal)
    ↓
反向传播 + 优化
    ↓
评估指标计算
```

## 关键特性

### 1. 条件化分割
- 使用FiLM (Feature-wise Linear Modulation) 将牙齿ID信息注入到特征中
- 在编码器的多个层级应用条件化
- 支持21种不同的牙齿ID

### 2. 多损失函数
- BCE损失：基础二元分类损失
- Dice损失：处理类别不平衡
- Focal损失：关注难分类样本

### 3. 完整评估
- 像素准确率 (Pixel Accuracy)
- 平均像素准确率 (mPA)
- IoU (Intersection over Union)
- 平均IoU (mIoU)
- Dice系数

### 4. 可视化工具
- 训练过程可视化
- 结果对比展示
- 注意力机制可视化
- 数据样本展示

## 使用流程

### 训练流程
1. 数据加载和预处理
2. 模型初始化
3. 损失函数和优化器设置
4. 训练循环 (前向传播 → 损失计算 → 反向传播)
5. 验证和早停
6. 模型保存

### 测试流程
1. 加载训练好的模型
2. 加载测试数据
3. 模型推理
4. 指标计算
5. 结果可视化
6. 结果保存

### 推理流程
1. 输入RGB图像和牙齿ID
2. 图像预处理
3. 模型推理
4. 输出分割mask
5. 后处理 (可选)

## 扩展性

### 模型改进
- 添加注意力机制
- 使用更深的网络架构
- 多尺度特征融合

### 数据增强
- 更多几何变换
- 颜色空间变换
- 混合增强技术

### 后处理
- 形态学操作
- 连通域分析
- 轮廓优化

## 性能优化

### 内存优化
- 混合精度训练
- 梯度累积
- 数据加载优化

### 计算优化
- GPU加速
- 批处理推理
- 模型量化

## 调试工具

### 训练监控
- TensorBoard日志
- 实时指标显示
- 学习率调度可视化

### 模型分析
- 注意力可视化
- 损失景观分析
- 梯度流分析

### 数据检查
- 数据样本展示
- 标签分布分析
- 数据质量检查
